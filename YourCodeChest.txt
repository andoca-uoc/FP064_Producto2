// crear.php
<?php
    require_once __DIR__ . '/../../models/db.php';
    require_once __DIR__ . '/../../models/actos.php';

	$db = db_connect();
	if(!$db) {
		die("Error al conectar con la base de datos");
	}
	
	if ($_SERVER['REQUEST_METHOD'] === 'POST')
	{
		//Se instancia el objeto
		$acto = new Acto();
		//Se obtienen los valores
		//$acto->Id_acto = $_POST['id'];
		$acto->Fecha = $_POST['Fecha'];
		$acto->Hora = $_POST['Hora'];
		$acto->Titulo = $_POST['Titulo'];
		$acto->Descripcion_corta = $_POST['Descripcion_corta'];
		$acto->Descripcion_larga = $_POST['Descripcion_larga'];
		$acto->Num_asistentes = $_POST['Num_asistentes'];
		$acto->Id_tipo_acto = $_POST['Id_tipo_acto'];
		
		if ($acto->crear()) {
			header('Location: /views/admin_panel.php');
		} else {
			echo "Error al crear el acto";
		}
	}
?>


// actos.php
<?php
require_once __DIR__ . "/db.php";

class Acto {
    private $conn;
    private $table = 'Actos';

    public $Id_acto;
    public $Fecha;
    public $Hora;
    public $Titulo;
    public $Descripcion_corta;
    public $Descripcion_larga;
    public $Num_asistentes;
    public $Id_tipo_acto;



    public function __construct() {
        $this->conn = db_connect();
    }

    public function leer() {
    	return db_query_fetchall('SELECT * FROM ' . $this->table);
    }

    public function leer_individual() {
        $query = 'SELECT * FROM ' . $this->table . ' WHERE Id_acto = ? LIMIT 0,1';
        $stmt = $this->conn->prepare($query);
        $stmt->bindParam(1, $this->Id_acto);
        $stmt->execute();
        $row = $stmt->fetch(PDO::FETCH_ASSOC);

        $this->Fecha = $row['Fecha'];
        $this->Hora = $row['Hora'];
        $this->Titulo = $row['Titulo'];
        $this->Descripcion_corta = $row['Descripcion_corta'];
        $this->Descripcion_larga = $row['Descripcion_larga'];
        $this->Num_asistentes = $row['Num_asistentes'];
        $this->Id_tipo_acto = $row['Id_tipo_acto'];
    }

  public function crear() {
		$query = 'INSERT INTO ' . $this->table . ' (Id_acto, Fecha, Hora, Titulo, Descripcion_corta, Descripcion_larga, Num_asistentes, Id_tipo_acto) VALUES (:Id_acto, :Fecha, :Hora, :Titulo, :Descripcion_corta, :Descripcion_larga, :Num_asistentes, :Id_tipo_acto)';
		$stmt = $this->conn->prepare($query);

		$stmt->bindParam(":Id_acto", $this->Id_acto);
		$stmt->bindParam(":Fecha", $this->Fecha);
		$stmt->bindParam(":Hora", $this->Hora);
		$stmt->bindParam(":Titulo", $this->Titulo);
		$stmt->bindParam(":Descripcion_corta", $this->Descripcion_corta);
		$stmt->bindParam(":Descripcion_larga", $this->Descripcion_larga);
		$stmt->bindParam(":Num_asistentes", $this->Num_asistentes);
		$stmt->bindParam(":Id_tipo_acto", $this->Id_tipo_acto);

		if ($stmt->execute())
		{
			return true;
		}
		return false;
	}

    public function actualizar() {
        $query = 'UPDATE ' . $this->table . ' SET Fecha=:Fecha, Hora=:Hora, Titulo=:Titulo, Descripcion_corta=:Descripcion_corta, Descripcion_larga=:Descripcion_larga, Num_asistentes=:Num_asistentes, Id_tipo_acto=:Id_tipo_acto WHERE Id_acto=:Id_acto';
        $stmt = $this->conn->prepare($query);

        $stmt->bindParam(":Id_acto", $this->Id_acto);
        $stmt->bindParam(":Fecha", $this->Fecha);
        $stmt->bindParam(":Hora", $this->Hora);
        $stmt->bindParam(":Titulo", $this->Titulo);
        $stmt->bindParam(":Descripcion_corta", $this->Descripcion_corta);
        $stmt->bindParam(":Descripcion_larga", $this->Descripcion_larga);
        $stmt->bindParam(":Num_asistentes", $this->Num_asistentes);
        $stmt->bindParam(":Id_tipo_acto", $this->Id_tipo_acto);

        if ($stmt->execute()) {
            return true;
        }
        return false;
    }

    public function borrar($id) {
        $query = 'DELETE FROM ' . $this->table . ' WHERE Id_acto = :Id_acto';
        return db_query_execute($query, [':Id_acto' => $id]);
    }
    
}
?>


// acciones.js
function abrirModalActualizar(acto) {
    document.querySelector('#formActualizarActo #update_id').value = acto.id || '';
    document.querySelector('#formActualizarActo #update_fecha').value = acto.date.split('-').reverse().join('-') || '';
    document.querySelector('#formActualizarActo #update_hora').value = acto.time || '';
    document.querySelector('#formActualizarActo #update_titulo').value = acto.title || '';
    document.querySelector('#formActualizarActo #update_descripcion_corta').value = acto.description1 || '';
    document.querySelector('#formActualizarActo #update_descripcion_larga').value = acto.description2 || '';
    document.querySelector('#formActualizarActo #update_num_asistentes').value = acto.audience || '';
    document.querySelector('#formActualizarActo #update_id_tipo_acto').value = acto.id_type || '';
    var modal = new bootstrap.Modal(document.getElementById('modalActualizar'));
    modal.show();
}

//Modal Acto Eliminar:
function confirmarEliminacion(url) {
    document.getElementById('btnEliminar').onclick = function() {
        window.location.href = url;
    };
    var modal = new bootstrap.Modal(document.getElementById('confirmarEliminacionModal'));
    modal.show();
}


// Modal Modicifcat tipo acto 
function confirmarEliminacionTipoActo(url) {
    document.getElementById('btnConfirmarEliminarTipoActo').href = url;
    var modal = new bootstrap.Modal(document.getElementById('confirmarBorradoTipoActoModal'));
    modal.show();
}

// Modal Modificar tipo acto 
function abrirModalActualizarTipoActo(tipoActo) {
    document.getElementById('floatingInputActualizar').value = tipoActo.id_tipo_acto;
    document.getElementById('Descripcion').value = tipoActo.descripcion;

    var modal = new bootstrap.Modal(document.getElementById('modalActualizarTipoActo'));
    modal.show();
}

// acto.php
<?php include '../controllers/actos/leer.php' ?>
<?php include '../controllers/actos/borrar.php' ?>
<?php include '../controllers/actos/actualizar.php' ?>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="../assets/css/general.css">
    <title>Panel Admin</title>
</head>

<body>
    <div class="container-fluid mt-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                <h1>Gestión de Actos</h1>
                </div>
            </nav>
        <div class="row">
            <div class="col text-end">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearActoModal">
                    Nuevo acto
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-light table-striped table-hover w-100 h-100">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Fecha</th>
                                <th scope="col">Hora</th>
                                <th scope="col">Titulo</th>
                                <th scope="col">Descripción Corta</th>
                                <th scope="col">Descripcion Larga</th>
                                <th scope="col">Numero de Asistentes</th>
                                <th scope="col">Id tipo de acto</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($actos as $acto) : ?>
                                <tr id="acto-<?php echo $acto['id']; ?>">
                                    <td><?php echo $acto['id']; ?></td>
                                    <td><?php echo $acto['date']; ?></td>
                                    <td><?php echo $acto['time']; ?></td>
                                    <td><?php echo $acto['title']; ?></td>
                                    <td><?php echo $acto['description1']; ?></td>
                                    <td><?php echo $acto['description2']; ?></td>
                                    <td><?php echo $acto['audience']; ?></td>
                                    <td><?php echo $acto['id_type']; ?></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button   button onclick="abrirModalActualizar(<?php echo htmlspecialchars(json_encode($acto)); ?>)" class="btn btn-sm btn-outline-secondary">Modificar</button>
                                        </div>

                                        <div class="btn-group" role="group">
                                        <a role="button" class="btn btn-sm btn-outline-danger" href="#" onclick="confirmarEliminacion('../controllers/actos/borrar.php?id=<?php echo $acto['id']; ?>')">Borrar</a>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</body>

</html>

// admin_panel.php
<?php
include '../lib/routes.php';
include './modales.php';
?>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin + Sidebar</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <link rel="stylesheet" href="/assets/css/general.css">
</head>

<body>
    <div class="wrapper">
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Panel de Administración</h3>
            </div>

            <ul class="list-unstyled components">
                <li>
                    <a href="admin_panel.php?page=acto">Actos</a>
                </li>
                <li>
                    <a href="admin_panel.php?page=ponente">Ponentes</a>
                </li>
                <li>
                    <a href="admin_panel.php?page=tipo_acto">Tipos de actos</a>
                </li>
                <li>
                    <a href="admin_panel.php?page=inscritos">Inscritos</a>
                </li>
            </ul>

            <ul class="list-unstyled CTAs">
                <li class="list-group-item list-group-item-info">
                    <a href="#">Perfil</a>
                </li>
            </ul>

            <ul class="list-unstyled CTAs">
                <li><a href="/login.php" class="article">Desconectarse</a></li>
            </ul>
        </nav>

        <div id="content">
            <?php
            $page = $_GET['page'] ?? 'default';
            handleRoute($page);
            ?>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./acciones.js"></script>
</body>

</html>

