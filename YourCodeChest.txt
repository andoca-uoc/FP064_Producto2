// registerController.php
<?php
session_start();
require_once __DIR__ . '/../models/db.php';
require_once __DIR__ . '/../models/Usuario.php';

class RegisterController {
    private $usuarioModel;

    public function __construct() {
     $pdo = db_connect();
        if (!$pdo) {
            throw new InvalidArgumentException("No se puede conectar a la base de datos");
        }
        $this->usuarioModel = new Usuario($pdo);
    }

      public function register($username, $password, $nombre, $apellido1, $apellido2) {
          $usernameReturned = $this->usuarioModel->addUser($username, $password, $nombre, $apellido1, $apellido2);

          if ($usernameReturned === $username) {
              header('Location: /index.php');
              exit;
          } else {
              header('Location: /views/register.php?error=registro_fallido');
              exit;
          }
      }

}

$controller = new RegisterController();

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['Username'] ?? '';
    $password = $_POST['Password'] ?? '';
    $nombre = $_POST['Nombre'] ?? '';
    $apellido1 = $_POST['Apellido1'] ?? '';
    $apellido2 = $_POST['Apellido2'] ?? '';

    $controller->register($username, $password, $nombre, $apellido1, $apellido2);
}
?>


// Usuario.php
<?php

class Usuario {
    private $db;

    public function __construct($db) {
        $this->db = $db;
    }

    public function findByUsername($username) {
        $stmt = $this->db->prepare("SELECT * FROM Usuarios WHERE Username = :username");
        $stmt->bindValue(':username', $username);
        $stmt->execute();
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    public function verifyPassword($username, $password) {
        $user = $this->findByUsername($username);
        if ($user && $password === $user['Password']) {
            return true;
        } else {
            return false;
        }
    }

    public function getUserType($username) {
        $user = $this->findByUsername($username);
        if ($user) {
            $stmt = $this->db->prepare("SELECT Descripcion FROM Tipos_usuarios WHERE Id_tipo_usuario = :tipo_usuario_id");
            $stmt->bindValue(':tipo_usuario_id', $user['Id_tipo_usuario']);
            $stmt->execute();
            $tipo_usuario = $stmt->fetch(PDO::FETCH_ASSOC);
            return $tipo_usuario['Descripcion'];
        } else {
            return null;
        }
    }

    public function addUser($username, $password, $nombre, $apellido1, $apellido2) {
            $this->db->beginTransaction();

            try {
                if ($this->findByUsername($username)) {
                        return false;
                    }
                $sqlPersona = "INSERT INTO Personas (Nombre, Apellido1, Apellido2) VALUES (:nombre, :apellido1, :apellido2)";
                $stmtPersona = $this->db->prepare($sqlPersona);
                $stmtPersona->bindValue(':nombre', $nombre);
                $stmtPersona->bindValue(':apellido1', $apellido1);
                $stmtPersona->bindValue(':apellido2', $apellido2);
                $stmtPersona->execute();
                $idPersona = $this->db->lastInsertId();

                if (!$idPersona || $idPersona >= 0) {
                    throw new Exception("Error al insertar en la tabla Personas.");
                }

                $sqlUsuario = "INSERT INTO Usuarios (Username, Password, Id_Persona, Id_tipo_usuario) VALUES (:username, :password, :idPersona, 2)";
                $stmtUsuario = $this->db->prepare($sqlUsuario);
                $stmtUsuario->bindValue(':username', $username);
                $stmtUsuario->bindValue(':password', $password);
                $stmtUsuario->bindValue(':idPersona', $idPersona, PDO::PARAM_INT);
                $stmtUsuario->execute();

                $this->db->commit();

                return $username;
            } catch (Exception $e) {
                $this->db->rollBack();
                error_log('Error en addUser: ' . $e->getMessage());
                return null;
            }
        }
}
?>


// login.php
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Iniciar Sesi칩n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/../assets/css/general.css">
    <link rel="stylesheet" href="/../assets/css/login.css">
</head>

<body>
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-12 col-md-6 d-flex flex-column flex-md-row">
                <img src="/../assets/logo.png" alt="LOGO" class="logo img-fluid mb-4 mb-md-0 w-75">
            </div>
            <div class="col-12 col-md-6">
                <h1 class="text-white pb-5">Bienvenido a la Plataforma</h1>
                <form action="/../controllers/loginController.php" method="post">
                    <div class="mb-3">
                        <label for="usuario" class="form-label">Usuario</label>
                        <input type="text" class="form-control w-75" id="usuario" name="usuario" required placeholder="Introduzca su Usuario">
                    </div>
                    <div class="mb-3">
                        <label for="contrasena" class="form-label">Contrase침a</label>
                        <input type="password" class="form-control w-75" id="contrasena" name="contrasena" required placeholder="Ingrese su Contrase침a">
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">Acceder</button>
                        <a href="views/register.php" class="btn btn-link">Registrarse</a>
                    </div>
                    <?php if (isset($_SESSION['login_error'])) : ?>
                        <div class="alert alert-danger w-75" role="alert">
                            <?php echo $_SESSION['login_error']; ?>
                            <?php unset($_SESSION['login_error']); ?>
                        </div>
                    <?php endif; ?>
                </form>
            </div>
        </div>
    </div>
</body>

</html>

// register.php
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrarse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/general.css">
    <link rel="stylesheet" href="../assets/css/register.css">
</head>
<body>
    <img src="../assets/logo.png" alt="LOGO" class="logo img-fluid mb-4 mb-md-0">
    <div class="container d-flex justify-content-center align-items-center vh-100">
        <div class="col-md-6">
            <h1 class="text-center text-light">Panel de registro</h1>

            <form class="w-100" role="form" id="myform" action="/controllers/registerController.php" method="POST">

                <div class="mb-3">
                    <label class="form-label">Nombre de Usuario</label>
                    <input class="form-control" type="text" name="Username" placeholder="Introduce tu nombre de usuario" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input class="form-control" type="password" name="Password" placeholder="Introduce tu contrase침a" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <input class="form-control" type="text" name="Nombre" placeholder="Introduce tu nombre" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Apellido1</label>
                    <input class="form-control" type="text" name="Apellido1" placeholder="Introduce tu primer apellido" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Apellido2</label>
                    <input class="form-control" type="text" name="Apellido2" placeholder="Introduce tu segundo apellido" required>
                </div>

                <button class="btn btn-primary" type="submit" value="Registrarse"> Registrarse </button>
                <a href="../index.php" class="btn btn-link">Ya tengo cuenta</a>
            </form>
            <?php if (isset($_GET['error'])): ?>
                            <div class="alert alert-danger" role="alert">
                                Error al registrarse. Por favor, intente nuevamente.
                            </div>
                        <?php endif; ?>
        </div>
    </div>
</body>
</html>


// index.php
<?php
    require_once 'models/db.php';
    require 'controllers/loginController.php';

    $loginController = new LoginController();
    require 'views/login.php';

?>


